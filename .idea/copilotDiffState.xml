<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/resources/JsonReportGenerator.vue">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/resources/JsonReportGenerator.vue" />
              <option name="updatedContent" value="&lt;script setup lang=&quot;ts&quot;&gt;&#10;import {ref, reactive, watch, nextTick} from 'vue';&#10;import axios from 'axios';&#10;import {Button} from '@/components/ui/button';&#10;import {Input} from '@/components/ui/input';&#10;import {Label} from '@/components/ui/label';&#10;import {ResizableHandle, ResizablePanel, ResizablePanelGroup} from '@/components/ui/resizable';&#10;import {Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle} from '@/components/ui/dialog';&#10;import {Separator} from &quot;@/components/ui/separator&quot;;&#10;import {LoaderCircle} from &quot;lucide-vue-next&quot;;&#10;import {useToast} from 'primevue/usetoast';&#10;import Icon from '@/components/Icon.vue';&#10;&#10;const toast = useToast();&#10;&#10;const props = defineProps&lt;{&#10;  modelValue: boolean;&#10;  activeFilters: Record&lt;string, any&gt;;&#10;  userRole: 'admin' | 'doctor';&#10;  reportType?: 'appointments' | 'doctors';&#10;  data?: any[];&#10;}&gt;();&#10;&#10;const emit = defineEmits(['update:modelValue']);&#10;&#10;interface JsonReportConfig {&#10;  title: string;&#10;  city: string;&#10;}&#10;&#10;const reportLoading = ref(false);&#10;const pdfUrl = ref&lt;string | null&gt;(null);&#10;let currentPdfBlobUrl: string | null = null;&#10;&#10;const reportConfig = reactive&lt;JsonReportConfig&gt;({&#10;  title: 'Raport',&#10;  city: 'Chełm'&#10;});&#10;&#10;const initializeConfig = () =&gt; {&#10;  reportConfig.title = props.reportType === 'doctors' ? 'Raport Lekarzy' : 'Zestawienie Wizyt';&#10;  reportConfig.city = 'Chełm';&#10;};&#10;&#10;const apiEndpoint = () =&gt; {&#10;  const rolePrefix = props.userRole === 'doctor' ? 'doctor' : 'admin';&#10;  if (props.reportType === 'doctors') {&#10;    return `/api/v1/admin/doctors/json-report`;&#10;  }&#10;  return `/api/v1/${rolePrefix}/appointments/json-report`;&#10;};&#10;&#10;const refreshPreview = async () =&gt; {&#10;  reportLoading.value = true;&#10;  if (currentPdfBlobUrl) {&#10;    URL.revokeObjectURL(currentPdfBlobUrl);&#10;  }&#10;&#10;  try {&#10;    const payload = {&#10;      jsonData: JSON.stringify(props.data || []),&#10;      title: reportConfig.title,&#10;      city: reportConfig.city&#10;    };&#10;&#10;    const response = await axios.post(apiEndpoint(), payload, {&#10;      responseType: 'blob',&#10;      params: props.activeFilters&#10;    });&#10;&#10;    const blob = new Blob([response.data], {type: 'application/pdf'});&#10;    currentPdfBlobUrl = URL.createObjectURL(blob);&#10;    pdfUrl.value = currentPdfBlobUrl;&#10;    toast.add({severity: 'success', summary: 'Sukces', detail: 'Podgląd odświeżony.', life: 2000});&#10;  } catch (error) {&#10;    console.error('Błąd podglądu:', error);&#10;    let errorText = 'Wystąpił nieznany błąd.';&#10;    if ((error as any).response?.data) {&#10;      try {&#10;        const errorData = (error as any).response.data;&#10;        if (errorData instanceof Blob) {&#10;          const text = await errorData.text();&#10;          try {&#10;            const jsonError = JSON.parse(text);&#10;            errorText = jsonError.details || jsonError.error || text;&#10;          } catch {&#10;            errorText = text;&#10;          }&#10;        } else if (typeof errorData === 'object') {&#10;          errorText = errorData.details || errorData.error || JSON.stringify(errorData);&#10;        } else {&#10;          errorText = errorData.toString();&#10;        }&#10;      } catch (e) {&#10;        console.error('Nie udało się sparsować odpowiedzi błędu:', e);&#10;      }&#10;    }&#10;    toast.add({severity: 'error', summary: 'Błąd generowania raportu', detail: errorText, life: 7000});&#10;    pdfUrl.value = null;&#10;  } finally {&#10;    reportLoading.value = false;&#10;  }&#10;};&#10;&#10;const downloadReport = () =&gt; {&#10;  if (!pdfUrl.value) {&#10;    toast.add({severity: 'warn', summary: 'Brak podglądu', detail: 'Najpierw odśwież podgląd.', life: 3000});&#10;    return;&#10;  }&#10;  const link = document.createElement('a');&#10;  link.href = pdfUrl.value;&#10;  link.setAttribute('download', `${reportConfig.title.replace(/\s/g, '_')}.pdf`);&#10;  document.body.appendChild(link);&#10;  link.click();&#10;  link.remove();&#10;};&#10;&#10;watch(() =&gt; props.modelValue, (newValue) =&gt; {&#10;  if (newValue) {&#10;    initializeConfig();&#10;    nextTick(() =&gt; {&#10;      refreshPreview();&#10;    });&#10;  }&#10;});&#10;&#10;watch(() =&gt; props.reportType, () =&gt; {&#10;  initializeConfig();&#10;});&#10;&lt;/script&gt;&#10;&#10;&lt;template&gt;&#10;  &lt;Dialog :open=&quot;props.modelValue&quot; @update:open=&quot;emit('update:modelValue', $event)&quot;&gt;&#10;    &lt;DialogContent class=&quot;w-[95vw] sm:w-[90vw] lg:w-[90vw] xl:w-[90vw] max-w-none h-[95vh] sm:h-[90vh] flex flex-col dark:bg-background bg-background border-nova-primary/20&quot;&gt;&#10;      &lt;DialogHeader class=&quot;border-b border-nova-primary/10&quot;&gt;&#10;        &lt;DialogTitle class=&quot;text-md sm:text-md text-nova-dark font-semibold&quot;&gt;Generator Raportów JSON&lt;/DialogTitle&gt;&#10;        &lt;DialogDescription class=&quot;text-xs sm:text-sm mb-1 text-muted-foreground&quot;&gt;&#10;          Raport jest automatycznie generowany z danych JSON. Ustaw tytuł i miasto dla strony tytułowej.&#10;        &lt;/DialogDescription&gt;&#10;      &lt;/DialogHeader&gt;&#10;&#10;      &lt;div class=&quot;flex-grow min-h-0&quot;&gt;&#10;        &lt;ResizablePanelGroup direction=&quot;horizontal&quot; class=&quot;h-full dark:bg-background bg-background w-full&quot;&gt;&#10;          &lt;!-- Panel konfiguracji --&gt;&#10;          &lt;ResizablePanel :default-size=&quot;30&quot; :min-size=&quot;20&quot; class=&quot;border-r dark:border-nova-primary/10 border-nova-primary/10&quot;&gt;&#10;            &lt;div class=&quot;flex flex-col h-full p-4&quot;&gt;&#10;              &lt;h3 class=&quot;text-lg font-semibold text-nova-dark mb-4&quot;&gt;Konfiguracja&lt;/h3&gt;&#10;              &#10;              &lt;div class=&quot;space-y-4&quot;&gt;&#10;                &lt;div&gt;&#10;                  &lt;Label for=&quot;report-title&quot; class=&quot;text-nova-dark font-medium&quot;&gt;Tytuł Raportu&lt;/Label&gt;&#10;                  &lt;Input &#10;                    id=&quot;report-title&quot; &#10;                    v-model=&quot;reportConfig.title&quot;&#10;                    class=&quot;mt-1 border-nova-primary/30 focus:border-nova-accent focus:ring-nova-accent/20&quot;&#10;                    placeholder=&quot;np. Zestawienie Wizyt&quot;&#10;                  /&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div&gt;&#10;                  &lt;Label for=&quot;report-city&quot; class=&quot;text-nova-dark font-medium&quot;&gt;Miasto (stopka)&lt;/Label&gt;&#10;                  &lt;Input &#10;                    id=&quot;report-city&quot; &#10;                    v-model=&quot;reportConfig.city&quot;&#10;                    class=&quot;mt-1 border-nova-primary/30 focus:border-nova-accent focus:ring-nova-accent/20&quot;&#10;                    placeholder=&quot;np. Chełm&quot;&#10;                  /&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;Separator class=&quot;my-4 bg-nova-primary/20&quot;/&gt;&#10;&#10;                &lt;div class=&quot;text-sm text-muted-foreground&quot;&gt;&#10;                  &lt;p class=&quot;mb-2 font-medium&quot;&gt;Raport zawiera:&lt;/p&gt;&#10;                  &lt;ul class=&quot;list-disc list-inside space-y-1&quot;&gt;&#10;                    &lt;li&gt;Stronę tytułową z logo&lt;/li&gt;&#10;                    &lt;li&gt;Automatycznie wykryte tabele&lt;/li&gt;&#10;                    &lt;li&gt;Formatowanie key-value&lt;/li&gt;&#10;                    &lt;li&gt;Stopkę z miastem i datą&lt;/li&gt;&#10;                  &lt;/ul&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/ResizablePanel&gt;&#10;&#10;          &lt;ResizableHandle with-handle class=&quot;bg-nova-primary/10 hover:bg-nova-primary/20&quot;/&gt;&#10;&#10;          &lt;!-- Panel podglądu --&gt;&#10;          &lt;ResizablePanel :default-size=&quot;70&quot; :min-size=&quot;50&quot;&gt;&#10;            &lt;div class=&quot;flex flex-col h-full items-center justify-center p-4&quot;&gt;&#10;              &lt;div v-if=&quot;reportLoading&quot; class=&quot;flex flex-col items-center text-nova-primary&quot;&gt;&#10;                &lt;LoaderCircle class=&quot;h-8 w-8 animate-spin mb-2&quot;/&gt;&#10;                &lt;p class=&quot;font-medium&quot;&gt;Generowanie podglądu...&lt;/p&gt;&#10;              &lt;/div&gt;&#10;              &lt;div v-else-if=&quot;pdfUrl&quot; class=&quot;w-full h-full&quot;&gt;&#10;                &lt;iframe :src=&quot;pdfUrl&quot; class=&quot;w-full h-full rounded-lg shadow-sm&quot; title=&quot;Podgląd Raportu&quot;&gt;&lt;/iframe&gt;&#10;              &lt;/div&gt;&#10;              &lt;div v-else class=&quot;text-center text-nova-primary&quot;&gt;&#10;                &lt;div class=&quot;bg-white/80 p-6 rounded-lg border border-nova-primary/20 shadow-sm&quot;&gt;&#10;                  &lt;p class=&quot;font-medium&quot;&gt;Podgląd raportu pojawi się tutaj.&lt;/p&gt;&#10;                  &lt;p class=&quot;text-sm mt-2 text-muted-foreground&quot;&gt;Kliknij &quot;Odśwież&quot; aby wygenerować raport.&lt;/p&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/ResizablePanel&gt;&#10;        &lt;/ResizablePanelGroup&gt;&#10;      &lt;/div&gt;&#10;&#10;      &lt;Separator class=&quot;bg-nova-primary/20&quot;/&gt;&#10;      &#10;      &lt;!-- Stopka z przyciskami --&gt;&#10;      &lt;div class=&quot;mt-2 pt-2 border-nova-primary/20 flex flex-col sm:flex-row items-center justify-between space-y-2 sm:space-y-0 p-4 rounded-md&quot;&gt;&#10;        &lt;Button &#10;          @click=&quot;refreshPreview&quot; &#10;          :disabled=&quot;reportLoading&quot; &#10;          variant=&quot;outline&quot;&#10;          class=&quot;w-full sm:w-auto border-nova-accent text-nova-accent hover:bg-nova-accent hover:text-white&quot;&#10;        &gt;&#10;          &lt;LoaderCircle v-if=&quot;reportLoading&quot; class=&quot;h-4 w-4 animate-spin mr-2&quot; /&gt;&#10;          &lt;Icon v-else name=&quot;refresh-cw&quot; class=&quot;mr-2&quot; size=&quot;16&quot;/&gt;&#10;          {{ reportLoading ? 'Odświeżanie...' : 'Odśwież' }}&#10;        &lt;/Button&gt;&#10;        &lt;Button &#10;          @click=&quot;downloadReport&quot; &#10;          :disabled=&quot;!pdfUrl || reportLoading&quot;&#10;          class=&quot;bg-nova-primary hover:bg-nova-dark text-white w-full sm:w-auto shadow-sm&quot;&#10;        &gt;&#10;          &lt;Icon name=&quot;download&quot; class=&quot;mr-2&quot; size=&quot;16&quot;/&gt;&#10;          Pobierz PDF&#10;        &lt;/Button&gt;&#10;      &lt;/div&gt;&#10;    &lt;/DialogContent&gt;&#10;  &lt;/Dialog&gt;&#10;&lt;/template&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>